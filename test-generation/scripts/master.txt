#!/usr/bin/env bash
#
# ------------------------------------------------------------------------------
# This script runs a job (i.e., an EvoSuite execution) on a specific SF110 class.
# ------------------------------------------------------------------------------

# Disable any pre-defined Java option
unset _JAVA_OPTIONS

source "/Users/jose/Research/fake-data-evosuite/data-repo/test-generation/scripts/../../utils/scripts/utils.sh" || exit 1

# -------------------------------------------------------------------------- Env

# Check whether the tools's dir is available
[ -n "$TOOLS_DIR" ]    || die "[ERROR] Environment variable TOOLS_DIR is not set!"
[ "$TOOLS_DIR" != "" ] || die "[ERROR] Environment variable TOOLS_DIR is empty!"
[ -d "$TOOLS_DIR" ]    || die "[ERROR] $TOOLS_DIR does not exist!"

# Check whether JAVA_HOME is set, is not empty, and does exist
[ -n "$JAVA_HOME" ]    || die "[ERROR] Environment variable JAVA_HOME is not set!"
[ "$JAVA_HOME" != "" ] || die "[ERROR] Environment variable JAVA_HOME is empty!"
[ -d "$JAVA_HOME" ]    || die "[ERROR] $JAVA_HOME does not exist!"

# Set classpath
export PATH="$JAVA_HOME/bin:$PATH"
# Sanity check whether `java` is indeed available
java -version > /dev/null 2>&1 || die "[ERROR] Failed to find the java executable."

# Check whether the SF110 dataset is available
[ -n "$SF100_DIR" ]    || die "[ERROR] Environment variable SF100_DIR is not set!"
[ "$SF100_DIR" != "" ] || die "[ERROR] Environment variable SF100_DIR is empty!"
[ -d "$SF100_DIR" ]    || die "[ERROR] $SF100_DIR does not exist!"

# ------------------------------------------------------------------------- Args
#
# Usage:
# job.sh
#   --project <project under test's name, e.g., 100_jgaap>
#   --class <class under test's name, e.g., AnalysisDriver>
#   --seed <random seed, e.g., 0>
#   --report_dir_path <path, e.g., reports/100_jgaap/AnalysisDriver/0/>
#   --test_dir_path <path, e.g., tests/100_jgaap/AnalysisDriver/0/>
#   [help] [> <path to job log file, e.g., logs/100_jgaap/AnalysisDriver/0/job.log> 2>&1]

# Print out this script's arguments (which could help any debug session)
echo "${BASH_SOURCE[0]} $@"

USAGE="Usage: ${BASH_SOURCE[0]} \
  --project <project under test's name, e.g., 100_jgaap> \
  --class <class under test's name, e.g., AnalysisDriver> \
  --seed <random seed, e.g., 0> \
  --report_dir_path <path, e.g., reports/100_jgaap/AnalysisDriver/0/> \
  --test_dir_path <path, e.g., tests/100_jgaap/AnalysisDriver/0/> \
  [help] [> <path to job log file, e.g., logs/100_jgaap/AnalysisDriver/0/job.log> 2>&1]"
if [ "$#" -ne "1" ] && [ "$#" -ne "10" ]; then
  die "$USAGE"
fi

PROJECT=""
CLASS=""
SEED=""
REPORT_DIR_PATH=""
TEST_DIR_PATH=""

while [[ "$1" = --* ]]; do
  OPTION=$1; shift
  case $OPTION in
    (--project)
      PROJECT=$1;
      shift;;
    (--class)
      CLASS=$1;
      shift;;
    (--seed)
      SEED=$1;
      shift;;
    (--report_dir_path)
      REPORT_DIR_PATH=$1;
      shift;;
    (--test_dir_path)
      TEST_DIR_PATH=$1;
      shift;;
    (--help)
      echo "$USAGE"
      exit 0
    (*)
      die "$USAGE";;
  esac
done

# Check whether all arguments have been initialized
[ "$PROJECT" != "" ]         || die "[ERROR] Missing --project argument!"
[ "$CLASS" != "" ]           || die "[ERROR] Missing --class argument!"
[ "$SEED" != "" ]            || die "[ERROR] Missing --seed argument!"
[ "$REPORT_DIR_PATH" != "" ] || die "[ERROR] Missing --report_dir_path argument!"
[ "$TEST_DIR_PATH" != "" ]   || die "[ERROR] Missing --test_dir_path argument!"

# Check whether required directories/files do exist
[ -d "$REPORT_DIR_PATH" ]   || die "[ERROR] $REPORT_DIR_PATH does not exist!"
[ -d "$TEST_DIR_PATH" ]     || die "[ERROR] $TEST_DIR_PATH does not exist!"

# Clean up output directories, in case of re-run of a unsuccessfully execution
# to avoid inconsistent data
find "$REPORT_DIR_PATH" -type f -exec rm -f {} \;
find "$TEST_DIR_PATH" -type f -exec rm -f {} \;
rm -rf "$REPORT_DIR_PATH"
rm -rf "$TEST_DIR_PATH"

# ------------------------------------------------------------------------- Main

# Create a temporary directory
TMP_ROOT_DIR="/tmp"
TMP_DIR_PATH="$TMP_ROOT_DIR/$USER-$$-$(echo $RANDOM | md5sum | cut -f1 -d' ')-$PROJECT-$CLASS"
[ ! -d "$TMP_DIR_PATH" ] || die "[ERROR] The pseudo-random $TMP_DIR_PATH directory already exists!"
mkdir -p "$TMP_DIR_PATH" || die "[ERROR] Failed to create $TMP_DIR_PATH!"

pushd . > /dev/null 2>&1
cd "$SF100_DIR/$PROJECT"
  # Run EvoSuite on each buggy class
  java -Djava.io.tmpdir="$TMP_DIR_PATH" -Xms4056M -Xmx4056M -jar "$TOOLS_DIR/test-generation-tools/evosuite-vanilla.jar" \
    -Dsearch_budget=180 `# As suggested in the paper` \
    `# Sina Shamshiri, René Just, José Miguel Rojas, Gordon Fraser, Phil McMinn, and Andrea Arcuri` \
    `# Do Automatically Generated Unit Tests Find Real Faults? An Empirical Study of Effectiveness and Challenges` \
    `# IEEE International Conference on Automated Software Engineering (ASE), 2015` \
    -seed "$SEED" \
    -Dgroup_id="$PROJECT-$CLASS" \
    -Dconfiguration_id="vanilla" \
    -Dreport_dir="$REPORT_DIR_PATH" \
    -Dtest_dir="$TEST_DIR_PATH" \
    -class "$CLASS" \
    -mem 8192 -permSize 256 `# As suggested in the paper` \
    `# Anjana Perera, Aldeida Aleti, Burak Turhan, and Marcel Bohme` \
    `# An Experimental Assessment of Using Theoretical Defect Predictors to Guide Search-Based Software Testing` \
    `# IEEE Transactions on Software Engineering (TSE), 2023` \
    -Dshow_progress=false `# true by default, disable to avoid having HUGE log files` \
    -Duse_deprecated=true `# false by default, enable to allow EvoSuite to explore ALL methods` \
    -Dp_functional_mocking=0.8 `# 0.0 by default, [0.8 has been suggested as the optimal value](https://github.com/EvoSuite/evosuite/blob/v1.2.0/client/src/main/java/org/evosuite/Properties.java#L288)` \
    -Dp_reflection_on_private=0.5 `# 0.0 by default, [0.5 has been suggested as the optimal value](https://github.com/EvoSuite/evosuite/blob/v1.2.0/client/src/main/java/org/evosuite/Properties.java#L280)` \
    -Djunit_check=false `# true by default, disable as any flaky / non-compiling test will then be removed by the pipeline` \
    -Dsave_all_data=false `# true by default, disable to avoid having data files` \
    -Dminimize=false `# true by default, false as suggested in the paper` \
    `# Anjana Perera, Aldeida Aleti, Burak Turhan, and Marcel Bohme` \
    `# An Experimental Assessment of Using Theoretical Defect Predictors to Guide Search-Based Software Testing` \
    `# IEEE Transactions on Software Engineering (TSE), 2023` \
    -Dminimization_timeout=600 `# 60 by default, more time to allow EvoSuite to complete the minimization step successfully` \
    -Dassertion_timeout=600 `# 60 by default, more time to allow EvoSuite to complete the generation of assertions successfully` \
    -Dglobal_timeout=600 `# 120 by default, more time to allow EvoSuite to complete all steps` \
    -Dextra_timeout=600 `# 60 by default, more time to allow EvoSuite to complete all steps` \
    -Dtimeout=6000 `# 3000 milliseconds to execute the body of a test by default; twice that time to avoid tests failing later in the pipeline due to time constraints` \
    -Dassertion_strategy="ALL" `# As suggested in the paper` \
    `# Sina Shamshiri, René Just, José Miguel Rojas, Gordon Fraser, Phil McMinn, and Andrea Arcuri` \
    `# Do Automatically Generated Unit Tests Find Real Faults? An Empirical Study of Effectiveness and Challenges` \
    `# IEEE International Conference on Automated Software Engineering (ASE), 2015` \
    -Dcriterion="LINE:BRANCH:EXCEPTION:WEAKMUTATION:OUTPUT:METHOD:METHODNOEXCEPTION:CBRANCH" \
    -Danalysis_criteria="LINE:BRANCH:EXCEPTION:WEAKMUTATION:OUTPUT:METHOD:METHODNOEXCEPTION:CBRANCH" \
    -Doutput_variables="configuration_id,\
                        group_id,\
                        Random_Seed,\
                        TARGET_CLASS,\
                        Size,\
                        Result_Size,\
                        Length,\
                        Result_Length,\
                        search_budget,\
                        Total_Time,\
                        criterion,\
                        algorithm,\
                        secondary_objectives,\
                        Fitness_Evaluations,\
                        Generations,\
                        population,\
                        mutation_rate,\
                        crossover_function,\
                        crossover_rate,\
                        selection_function,\
                        rank_bias,\
                        tournament_size,\
                        elite,\
                        LineCoverage,\
                        LineCoverageBitString,\
                        BranchCoverage,\
                        BranchCoverageBitString,\
                        ExceptionCoverage,\
                        ExceptionCoverageBitString,\
                        WeakMutationScore,\
                        WeakMutationCoverageBitString,\
                        OutputCoverage,\
                        OutputCoverageBitString,\
                        MethodCoverage,\
                        MethodCoverageBitString,\
                        MethodNoExceptionCoverage,\
                        MethodNoExceptionCoverageBitString,\
                        CBranchCoverage,\
                        CBranchCoverageBitString" \
    -generateMOSuite -Dstrategy=MOSUITE || die "[ERROR] Failed to run EvoSuite on $PROJECT-$CLASS!"

  # Sanity checks

  ## Did EvoSuite generate anything?  In other words, does the `statistics.csv` file exist and it is not empty?
  report_file_path="$REPORT_DIR_PATH/statistics.csv"
  [ -s "$report_file_path" ] || die "[ERROR] $report_file_path does not exist or it is empty!"
  fix_line_break "$report_file_path" || die
  ## Does the `statistics.csv` contain any data?
  num_rows_stats_file=$(wc -l < "$report_file_path")
  [ "$num_rows_stats_file" -eq "2" ] || die "[ERROR] The statistics file ($report_file_path) generated by EvoSuite has no data!"

  ## Did EvoSuite generate at least one test suite or as many test suites as the number of classes it was invoked on?
  num_gen_test_suites=$(find "$TEST_DIR_PATH" -type f -name "*ESTest.java" | wc -l)
  [ "$num_gen_test_suites" -eq "1" ] || die "[ERROR] EvoSuite failed to generate any test suite!"
  ## Are the generated test suites not empty?
  num_empty_gen_test_suites=$(find "$TEST_DIR_PATH" -type f -name "*ESTest.java" -size 0 | wc -l)
  [ "$num_empty_gen_test_suites" -eq "0" ] || die "[ERROR] There are $num_empty_gen_test_suites empty test suites!"
popd > /dev/null 2>&1

# Remove the temporary directory once the job is finished
rm -rf "$TMP_DIR_PATH"

echo "DONE!"
exit 0

# EOF
